@{
    ViewData["Title"] = "Admin Dashboard";
}
@using Newtonsoft.Json

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { background-color: #f4f6f9; }
    
    .sidebar {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 20px 0;
    }
    .sidebar-title {
        padding: 0 20px 15px;
        font-weight: 700;
        color: #343a40;
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 10px;
    }
    .nav-link {
        color: #495057;
        padding: 12px 20px;
        border-radius: 0;
        transition: all 0.2s;
        border-left: 3px solid transparent;
    }
    .nav-link:hover {
        background: #f8f9fa;
        color: #0d6efd;
        border-left-color: #0d6efd;
    }
    .nav-link i { width: 24px; }

    .dashboard-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
    }
    .dashboard-header h1 { font-weight: 700; margin: 0; }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        transition: all 0.3s;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.12);
    }
    .stat-card .stat-icon {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 4rem;
        opacity: 0.1;
    }
    .stat-card .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: #dc3545;
    }
    .stat-card .stat-label {
        color: #6c757d;
        font-size: 0.95rem;
    }
    .stat-card.card-revenue { border-left: 4px solid #28a745; }
    .stat-card.card-pending { border-left: 4px solid #ffc107; }
    .stat-card.card-sales { border-left: 4px solid #6f42c1; }
    .stat-card.card-students { border-left: 4px solid #fd7e14; }
    .stat-card.card-teachers { border-left: 4px solid #20c997; }
    .stat-card.card-staff { border-left: 4px solid #e83e8c; }

    .section-title {
        background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        margin: 30px 0 20px;
        font-weight: 700;
    }

    .card-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 20px;
    }
    .table thead th {
        background: #e9ecef;
        color: #212529;
        font-weight: 600;
        border: none;
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 20px;
    }

    .filter-form {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
</style>

<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-2 col-md-3 mb-4">
            <div class="sidebar">
                <div class="sidebar-title">HOẠT ĐỘNG</div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" asp-action="Index2"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-action="Index"><i class="fas fa-users me-2"></i>Quản lý người dùng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-action="QuanLyStaff"><i class="fas fa-user-cog me-2"></i>Quản lý Staff</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-action="QuanLyStudent"><i class="fas fa-user-graduate me-2"></i>Quản lý Student</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-action="QuanLyTeacher"><i class="fas fa-chalkboard-teacher me-2"></i>Quản lý Teacher</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-action="QuanLyNo"><i class="fas fa-wallet me-2"></i>Quản lý nợ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-action="DoanhThu"><i class="fa-solid fa-receipt me-2"></i>Hoạt động hóa đơn</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-controller="ChuyenNganh" asp-action="Index"><i class="fa-solid fa-layer-group me-2"></i>Quản lý chuyên ngành</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" asp-area="Staff" asp-controller="StaffHome" asp-action="Index"><i class="fa-solid fa-user-tie me-2"></i>Quản lý học vụ</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-10 col-md-9">
            <div class="dashboard-header">
                <h1>ADMIN DASHBOARD</h1>
            </div>

            <!-- Stats Cards -->
            <div class="row g-4 mb-4">
                <div class="col-lg-4 col-md-6">
                    <a asp-action="DoanhThu" class="text-decoration-none">
                        <div class="stat-card card-revenue">
                            <i class="fa-solid fa-dollar-sign stat-icon"></i>
                            <div class="stat-label">Doanh thu tháng @DateTime.Now.Month/@DateTime.Now.Year</div>
                            <div class="stat-value">@ViewBag.DoanhThuThang VND</div>
                        </div>
                    </a>
                </div>
                <div class="col-lg-4 col-md-6">
                    <a asp-action="QuanLyNo" class="text-decoration-none">
                        <div class="stat-card card-pending">
                            <i class="fas fa-hourglass-half stat-icon"></i>
                            <div class="stat-label">Tổng tiền chờ thanh toán</div>
                            <div class="stat-value">@ViewBag.TienConThieu VND</div>
                        </div>
                    </a>
                </div>
                <div class="col-lg-4 col-md-6">
                    <a asp-action="DoanhThu" class="text-decoration-none">
                        <div class="stat-card card-sales">
                            <i class="fas fa-coins stat-icon"></i>
                            <div class="stat-label">Khóa học bán được tháng @DateTime.Now.Month/@DateTime.Now.Year</div>
                            <div class="stat-value">@ViewBag.SoLuongKHBanThangHienTai</div>
                        </div>
                    </a>
                </div>
                <div class="col-lg-4 col-md-6">
                    <a asp-action="QuanLyStudent" class="text-decoration-none">
                        <div class="stat-card card-students">
                            <i class="fa-solid fa-graduation-cap stat-icon"></i>
                            <div class="stat-value">@ViewBag.SLStudent</div>
                            <div class="stat-label">Học viên</div>
                        </div>
                    </a>
                </div>
                <div class="col-lg-4 col-md-6">
                    <a asp-action="QuanLyTeacher" class="text-decoration-none">
                        <div class="stat-card card-teachers">
                            <i class="fa-solid fa-chalkboard-user stat-icon"></i>
                            <div class="stat-value">@ViewBag.SLTeacher</div>
                            <div class="stat-label">Giảng viên</div>
                        </div>
                    </a>
                </div>
                <div class="col-lg-4 col-md-6">
                    <a asp-action="QuanLyStaff" class="text-decoration-none">
                        <div class="stat-card card-staff">
                            <i class="fas fa-server stat-icon"></i>
                            <div class="stat-value">@ViewBag.SLStaff</div>
                            <div class="stat-label">Nhân viên</div>
                        </div>
                    </a>
                </div>
            </div>

            <!-- Statistics Section -->
            <div class="section-title">
                THỐNG KÊ TỔNG QUAN
            </div>

            <div class="filter-form">
                <form method="get" id="filterForm">
                    <div class="row align-items-end">
                        <div class="col-md-4">
                            <label for="nam" class="form-label fw-bold">Thống kê theo năm</label>
                            <select class="form-select" name="nam" id="nam">
                                @foreach (int y in ViewBag.allYears)
                                {
                                    <option value="@y" selected="@(ViewBag.NamDangChon == y ? "selected" : null)">@y</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="thang" class="form-label fw-bold">Thống kê theo tháng</label>
                            <select class="form-select" name="thang" id="thang">
                                @foreach (int y in ViewBag.allMonths)
                                {
                                    <option value="@y" selected="@(ViewBag.ThangDangChon == y ? "selected" : null)">@y</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fa-solid fa-chart-simple me-2"></i>Thống kê
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="row g-4">
                <div class="col-lg-4">
                    <div class="card-table h-100">
                        <h5 class="fw-bold text-primary mb-3">Top 5 khóa học được đăng ký nhiều nhất</h5>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Tên khóa học</th>
                                    <th>Số lượt</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ViewBag.Top5KhoaHoc != null && ViewBag.Top5KhoaHoc.Count > 0)
                                {
                                    int stt = 1;
                                    foreach (var item in ViewBag.Top5KhoaHoc)
                                    {
                                        <tr>
                                            <td>@stt</td>
                                            <td>@item.TenKhoaHoc</td>
                                            <td class="fw-bold text-primary">@item.SoLuongDangKy</td>
                                        </tr>
                                        stt++;
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="3" class="text-center text-muted">Không có dữ liệu</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="chart-container">
                        <canvas id="myChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section-title mt-4">
                THỐNG KÊ DOANH THU
            </div>
            <div class="chart-container">
                <canvas id="DoanhThuChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('myChart');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"],
            datasets: [
                { label: 'Số lượt đăng ký khóa học', data: @JsonConvert.SerializeObject(ViewBag.SLDKTheoThang), borderWidth: 3, order: 2, type: 'bar', backgroundColor: 'rgba(13, 110, 253, 0.7)' },
                { label: 'Số lượt đăng ký nợ khóa học', data: @JsonConvert.SerializeObject(ViewBag.SLNoTheoThang), borderWidth: 5, type: 'line', order: 0, pointBackgroundColor: 'rgba(255, 99, 132, 1)', pointRadius: 5, pointHoverRadius: 8, tension: 0.3, borderColor: 'rgba(255, 99, 132, 1)' }
            ]
        },
        options: { scales: { y: { beginAtZero: true } }, plugins: { title: { display: true, text: 'BIỂU ĐỒ THỐNG KÊ SỐ LƯỢNG PHIẾU ĐĂNG KÝ KHÓA HỌC VÀ NỢ HỌC PHÍ' } } }
    });

    const ctx2 = document.getElementById('DoanhThuChart');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"],
            datasets: [
                { label: 'Tổng tiền (VNĐ)', data: @JsonConvert.SerializeObject(ViewBag.TongTienTheoThang), borderWidth: 2, order: 1, backgroundColor: 'rgba(40, 167, 69, 0.7)', pointRadius: 5, pointHoverRadius: 8 },
                { label: 'Tiền chờ thanh toán (VNĐ)', data: @JsonConvert.SerializeObject(ViewBag.TongNoTheoThang), borderWidth: 2, order: 0, backgroundColor: 'rgba(255, 193, 7, 0.7)', pointRadius: 5, pointHoverRadius: 8 }
            ]
        },
        options: { scales: { y: { beginAtZero: true } }, plugins: { title: { display: true, text: 'BIỂU ĐỒ THỐNG KÊ DOANH THU VÀ HỌC PHÍ' } } }
    });
</script>
