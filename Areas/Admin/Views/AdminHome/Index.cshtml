@model DoAnCoSo_Web.Areas.Admin.ViewModels.UserFilterViewModel
@using Microsoft.AspNetCore.Identity
@inject UserManager<DoAnCoSo_Web.Models.User> UserManager
@{
    ViewData["Title"] = "Quản lý người dùng";
    var statusMessage = TempData["StatusMessage"] as string;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.css">

<style>
    body { background-color: #f4f6f9; }
    .page-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
        padding: 24px 30px;
        border-radius: 12px;
        margin-bottom: 24px;
        box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
    }
    .page-header h2 { margin: 0; font-weight: 700; }
    .page-header p { margin: 8px 0 0; opacity: 0.9; }
    .card-table {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 24px;
    }
    .filter-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 20px;
        margin-bottom: 20px;
    }
    .table thead th {
        background: #e9ecef;
        color: #212529;
        font-weight: 600;
        border: none;
        padding: 14px 12px;
    }
    .table tbody td {
        padding: 14px 12px;
        vertical-align: middle;
    }
    .table tbody tr:hover { background-color: #f8f9fa; }
    .btn-back {
        background: white;
        color: #6c757d;
        border: 1px solid #dee2e6;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 500;
    }
    .btn-action {
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.85rem;
        margin: 2px;
    }
    .btn-add {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        color: white;
    }
    .badge-role {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .badge-admin { background: #dc3545; color: white; }
    .badge-staff { background: #e83e8c; color: white; }
    .badge-teacher { background: #20c997; color: white; }
    .badge-student { background: #fd7e14; color: white; }
    .alert-custom {
        border-radius: 8px;
        border: none;
        padding: 12px 16px;
    }
</style>

<div class="container-fluid py-4">
    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert alert-success alert-custom alert-dismissible fade show">
            <i class="fa-solid fa-check-circle me-2"></i>@statusMessage
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-custom alert-dismissible fade show">
            <i class="fa-solid fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-custom alert-dismissible fade show">
            <i class="fa-solid fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <a asp-controller="AdminHome" asp-action="Index2" class="btn btn-back mb-3">
        <i class="fa-solid fa-arrow-left me-2"></i>Quay lại
    </a>

    <div class="page-header">
        <h2><i class="fa-solid fa-users-gear me-2"></i>Quản lý người dùng</h2>
    </div>

    <div class="filter-card">
        <form method="get">
            <div class="row align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Lọc theo vai trò</label>
                    <select name="role" class="form-select">
                        <option value="">-- Tất cả vai trò --</option>
                        <option value="Admin" selected="@(Model.Role == "Admin" ? "selected" : null)">Admin</option>
                        <option value="Staff" selected="@(Model.Role == "Staff" ? "selected" : null)">Staff</option>
                        <option value="Teacher" selected="@(Model.Role == "Teacher" ? "selected" : null)">Teacher</option>
                        <option value="Student" selected="@(Model.Role == "Student" ? "selected" : null)">Student</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Lọc theo trạng thái</label>
                    <select name="status" class="form-select">
                        <option value="">-- Tất cả trạng thái --</option>
                        <option value="pending" selected="@(Model.Status == "pending" ? "selected" : null)">Chờ duyệt</option>
                        <option value="active" selected="@(Model.Status == "active" ? "selected" : null)">Hoạt động</option>
                        <option value="banned" selected="@(Model.Status == "banned" ? "selected" : null)">Bị cấm</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fa-solid fa-filter me-1"></i>Lọc
                    </button>
                    <a asp-area="Admin" asp-controller="AdminHome" asp-action="Index" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-rotate-left me-1"></i>Hủy lọc
                    </a>
                </div>
            </div>
        </form>
    </div>

    <div class="card-table">
        <table id="example" class="table table-striped" style="width:100%">
            <thead>
                <tr>
                    <th>Email</th>
                    <th>Họ tên</th>
                    <th>Vai trò</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var userWithRoles in Model.Users)
                {
                    var user = userWithRoles.User;
                    var roles = userWithRoles.Roles;
                    var isStudent = roles.Contains("Student");

                    <tr>
                        <td>@user.Email</td>
                        <td><strong>@user.HoTen</strong></td>
                        <td>
                            @foreach (var role in roles)
                            {
                                var badgeClass = role switch
                                {
                                    "Admin" => "badge-admin",
                                    "Staff" => "badge-staff",
                                    "Teacher" => "badge-teacher",
                                    "Student" => "badge-student",
                                    _ => "bg-secondary"
                                };
                                <span class="badge-role @badgeClass">@role</span>
                            }
                        </td>
                        <td>
                            @if (user.IsBanned)
                            {
                                <span class="badge bg-danger"><i class="fa-solid fa-ban me-1"></i>Bị cấm</span>
                            }
                            else if (user.IsApproved)
                            {
                                <span class="badge bg-success"><i class="fa-solid fa-check me-1"></i>Hoạt động</span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark"><i class="fa-solid fa-clock me-1"></i>Chờ duyệt</span>
                            }
                        </td>
                        <td>
                            @if (!isStudent && !user.IsApproved)
                            {
                                <form asp-action="ApproveUser" method="post" style="display:inline">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit" class="btn btn-success btn-action">
                                        <i class="fa-solid fa-check me-1"></i>Duyệt
                                    </button>
                                </form>
                                <form asp-action="RejectUser" method="post" style="display:inline" onsubmit="return confirm('Bạn có chắc muốn từ chối tài khoản này?');">
                                    <input type="hidden" name="userId" value="@user.Id" />
                                    <button type="submit" class="btn btn-danger btn-action">
                                        <i class="fa-solid fa-xmark me-1"></i>Từ chối
                                    </button>
                                </form>
                            }
                            else
                            {
                                @if (user.IsMainAdmin)
                                {
                                    <span class="text-muted fst-italic"><i class="fa-solid fa-shield me-1"></i>Admin gốc</span>
                                }
                                else
                                {
                                    @if (!user.IsBanned)
                                    {
                                        <form asp-action="BanUser" method="post" style="display:inline" onsubmit="return confirm('Bạn có chắc chắn muốn cấm người dùng này không?');">
                                            <input type="hidden" name="userId" value="@user.Id" />
                                            <button type="submit" class="btn btn-outline-danger btn-action">
                                                <i class="fa-solid fa-ban me-1"></i>Cấm
                                            </button>
                                        </form>
                                    }
                                    else
                                    {
                                        <form asp-action="UnBanUser" method="post" style="display:inline" onsubmit="return confirm('Bạn có chắc muốn gỡ cấm người dùng này không?');">
                                            <input type="hidden" name="userId" value="@user.Id" />
                                            <button type="submit" class="btn btn-outline-success btn-action">
                                                <i class="fa-solid fa-unlock me-1"></i>Gỡ cấm
                                            </button>
                                        </form>
                                    }
                                }
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="mt-4">
            <a href="@Url.Page("/Users/AddUser", new { area = "Admin" })" class="btn btn-add">
                <i class="fa-solid fa-user-plus me-2"></i>Thêm người dùng
            </a>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
<script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"></script>
<script>
    new DataTable('#example', {
        columnDefs: [
            { targets: 0, searchable: true },
            { targets: [1, 2, 3, 4], searchable: false }
        ],
        language: {
            search: "Tìm kiếm:",
            lengthMenu: "Hiển thị _MENU_ dòng",
            info: "Hiển thị _START_ đến _END_ của _TOTAL_ dòng",
            paginate: { previous: "Trước", next: "Sau" },
            zeroRecords: "Không tìm thấy kết quả phù hợp"
        }
    });
</script>
